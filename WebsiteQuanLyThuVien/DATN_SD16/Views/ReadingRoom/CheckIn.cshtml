@{
    ViewData["Title"] = "Check-in QR";
    Layout = "~/Views/Shared/_UserLayout.cshtml";
}

<div class="max-w-3xl mx-auto">
    <!-- Back Button -->
    <div class="mb-4">
        <a href="@Url.Action("MyReservations")" class="inline-flex items-center gap-2 text-primary hover:underline">
            <span class="material-symbols-outlined">arrow_back</span>
            Quay lại đặt chỗ của tôi
        </a>
    </div>

    <!-- Header -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6 mb-6">
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">
            <span class="material-symbols-outlined align-middle">qr_code_scanner</span>
            Check-in bằng QR Code
        </h1>
        <p class="text-gray-600 dark:text-gray-400">
            Quét mã QR tại chỗ ngồi để check-in
        </p>
    </div>

    <!-- QR Scanner -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
        <!-- Camera View -->
        <div id="qr-reader" class="rounded-lg overflow-hidden mb-4"></div>

        <!-- Manual Input Option -->
        <div class="border-t border-gray-200 dark:border-gray-700 pt-6 mt-6">
            <h3 class="font-semibold text-gray-900 dark:text-white mb-4">Hoặc nhập mã QR thủ công</h3>
            <form id="manualCheckInForm">
                <div class="flex gap-2">
                    <input type="text" 
                           id="manualQRCode"
                           placeholder="Nhập mã QR"
                           class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" />
                    <button type="submit" 
                            class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-blue-600 transition">
                        Check-in
                    </button>
                </div>
            </form>
        </div>

        <!-- Status Messages -->
        <div id="checkInSuccess" class="hidden mt-4 p-4 bg-green-100 border border-green-300 text-green-800 rounded-lg">
            <div class="flex items-center gap-2">
                <span class="material-symbols-outlined">check_circle</span>
                <span id="successMessage"></span>
            </div>
        </div>

        <div id="checkInError" class="hidden mt-4 p-4 bg-red-100 border border-red-300 text-red-800 rounded-lg">
            <div class="flex items-center gap-2">
                <span class="material-symbols-outlined">error</span>
                <span id="errorMessage"></span>
            </div>
        </div>

        <!-- Loading -->
        <div id="checkInLoading" class="hidden mt-4 p-4 bg-blue-100 border border-blue-300 text-blue-800 rounded-lg">
            <div class="flex items-center gap-2">
                <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>Đang xử lý...</span>
            </div>
        </div>
    </div>

    <!-- Instructions -->
    <div class="mt-6 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-6">
        <h3 class="font-semibold text-blue-900 dark:text-blue-200 mb-3">
            <span class="material-symbols-outlined align-middle">info</span>
            Hướng dẫn check-in
        </h3>
        <ol class="space-y-2 text-sm text-blue-800 dark:text-blue-300 list-decimal list-inside">
            <li>Đến phòng đọc và tìm chỗ ngồi bạn đã đặt</li>
            <li>Mở camera và quét mã QR trên bàn/ghế</li>
            <li>Hoặc nhập mã QR thủ công vào ô bên trên</li>
            <li>Hệ thống sẽ tự động xác nhận và check-in cho bạn</li>
            <li>Nhớ check-out khi rời đi để người khác có thể sử dụng</li>
        </ol>
    </div>
</div>

@section Scripts {
<script src="https://unpkg.com/html5-qrcode"></script>
<script>
    let html5QrCode;
    let currentReservationId = null;

    // Initialize QR Scanner
    function initQRScanner() {
        html5QrCode = new Html5Qrcode("qr-reader");
        
        const config = {
            fps: 10,
            qrbox: { width: 250, height: 250 }
        };

        html5QrCode.start(
            { facingMode: "environment" },
            config,
            onScanSuccess,
            onScanError
        ).catch(err => {
            console.error("Unable to start QR scanner:", err);
            document.getElementById('errorMessage').textContent = 'Không thể khởi động camera. Vui lòng sử dụng nhập mã thủ công.';
            document.getElementById('checkInError').classList.remove('hidden');
        });
    }

    function onScanSuccess(decodedText, decodedResult) {
        console.log(`QR Code scanned: ${decodedText}`);
        
        // Stop scanning
        html5QrCode.stop();
        
        // Process check-in
        processCheckIn(decodedText);
    }

    function onScanError(error) {
        // Ignore scan errors (they happen constantly while scanning)
    }

    async function processCheckIn(qrCode) {
        const loadingDiv = document.getElementById('checkInLoading');
        const successDiv = document.getElementById('checkInSuccess');
        const errorDiv = document.getElementById('checkInError');

        loadingDiv.classList.remove('hidden');
        successDiv.classList.add('hidden');
        errorDiv.classList.add('hidden');

        try {
            // First, get user's reservations to find matching one
            const response = await fetch('/ReadingRoom/CheckInWithQR', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ qrCode: qrCode })
            });

            const data = await response.json();

            loadingDiv.classList.add('hidden');

            if (data.success) {
                document.getElementById('successMessage').textContent = data.message;
                successDiv.classList.remove('hidden');
                
                // Redirect after 2 seconds
                setTimeout(() => {
                    window.location.href = data.redirectUrl || '@Url.Action("MyReservations")';
                }, 2000);
            } else {
                document.getElementById('errorMessage').textContent = data.message;
                errorDiv.classList.remove('hidden');
                
                // Restart scanner after error
                setTimeout(() => {
                    errorDiv.classList.add('hidden');
                    initQRScanner();
                }, 3000);
            }
        } catch (error) {
            loadingDiv.classList.add('hidden');
            document.getElementById('errorMessage').textContent = 'Có lỗi xảy ra: ' + error.message;
            errorDiv.classList.remove('hidden');
        }
    }

    // Manual check-in form
    document.getElementById('manualCheckInForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const qrCode = document.getElementById('manualQRCode').value.trim();
        
        if (!qrCode) {
            document.getElementById('errorMessage').textContent = 'Vui lòng nhập mã QR';
            document.getElementById('checkInError').classList.remove('hidden');
            return;
        }

        processCheckIn(qrCode);
    });

    // Initialize on page load
    window.addEventListener('DOMContentLoaded', function() {
        initQRScanner();
    });
</script>
}

